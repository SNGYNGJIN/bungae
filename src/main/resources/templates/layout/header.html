<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <script th:src="@{/js/sse_connect.js}" type="text/javascript"></script>
</head>

<body>
<header>
    <nav class="navbar navbar-expand-md bg-primary navbar-light border-bottom border-dark" style="height: 80px;">
        <div class="container">
            <a class="navbar-brand" th:href="@{/main}">
                <img th:src="@{/images/bungae.png}" width="100" height="30" class="d-inline-block align-top" alt="">
            </a>
            <button class="navbar-toggler navbar-toggler-right border-0" type="button" data-toggle="collapse" data-target="#navbar16">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div id="messages"></div>
            <div class="collapse navbar-collapse" id="navbar16">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item"><a class="nav-link" th:href="@{/main}">홈</a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/map}">지도</a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/bungae_create}">번개생성</a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/bungae_list}">번개목록</a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/bungae/bungae_ing}">참여목록</a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/profile}">프로필</a></li>
                </ul>
                <a id="loginLogoutButton" class="btn navbar-btn ml-md-2 btn-light text-dark" href="#">로그인</a>
            </div>
        </div>
    </nav>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 로그인/로그아웃 처리
            const loggedInUserId = sessionStorage.getItem("loggedInUserId");
            const loginLogoutButton = document.getElementById('loginLogoutButton');

            if (!loginLogoutButton) {
                console.error("loginLogoutButton element not found.");
                return;
            }

            console.log("Logged in user ID:", loggedInUserId);

            if (loggedInUserId) {
                loginLogoutButton.textContent = '로그아웃';
                loginLogoutButton.href = '#';
            } else {
                loginLogoutButton.textContent = '로그인';
                loginLogoutButton.href = 'login';
            }

            loginLogoutButton.addEventListener('click', function (event) {
                if (loggedInUserId) {
                    event.preventDefault();
                    sessionStorage.removeItem("loggedInUserId");
                    window.location.href = '/login';
                }
            });

            // SSE 연결 처리
            console.log("sse_connect.js loaded");
            let eventSource;

            if (!loggedInUserId) {
                console.error("No logged in user ID found in sessionStorage");
                return;
            }
        });

    </script>
</header>
</body>
</html>
<!--
            checkAndSubscribe();

            function checkAndSubscribe() {
                $.ajax({
                    url: `/chat/api/findDisconnect/${loggedInUserId}`,
                    method: 'GET',
                    success: function(response) {
                        if (response === true) {

                            subscribeToSSE();
                        } else if (response === false) {
                            // 구독 끊기
                            if (eventSource && eventSource.readyState !== EventSource.CLOSED) {
                                eventSource.close();
                                sessionStorage.removeItem('sseSubscribed');
                                console.log("SSE 구독이 끊어졌습니다.");
                            }
                        }
                    },
                    error: function(error) {
                        console.error("Error : ", error);
                    }
                });
            }

            function subscribeToSSE() {
                console.log("subscribeToSSE called");
                if (!eventSource || eventSource.readyState === EventSource.CLOSED) {
                    eventSource = new EventSource("/alarm/subscribe/" + loggedInUserId);
                    console.log("Subscribing to SSE for user:", loggedInUserId);

                    eventSource.onmessage = function(event) {
                        alert("Message received: " + event.data);
                        const div = document.createElement("div");
                        div.textContent = `Event received: ${event.data}`;
                        document.getElementById("messages").appendChild(div);
                        console.log(event.data);
                    };

                    eventSource.onerror = function(error) {
                        console.error("Error occurred: ", error);
                        // SSE 연결이 끊어졌을 때 재연결 시도
                        setTimeout(function() {
                            subscribeToSSE();
                        }, 3000); // 3초 후 재구독 시도
                    };

                    // SSE 상태를 세션 스토리지에 저장
                    sessionStorage.setItem('sseSubscribed', 'true');
                }
            }

            function unsubscribe() {
                console.log("unsubscribe called");
                if (eventSource) {
                    $.ajax({
                        url: "/alarm/unsubscribe/" + loggedInUserId,
                        method: 'DELETE',
                        success: function() {
                            console.log("사용자가 채팅방에 들어갔습니다. SSE 구독이 끊어졌습니다.");
                        },
                        error: function(error) {
                            console.error("Error : ", error);
                        }
                    });

                    eventSource.close();
                    sessionStorage.removeItem('sseSubscribed');
                }
            }

            window.addEventListener('beforeunload', unsubscribe);
            window.addEventListener('enterChat', function(event) {
                console.log("enterChat event received");
                unsubscribe();
            });
        });







-->