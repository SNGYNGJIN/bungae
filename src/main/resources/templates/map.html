<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
          type="text/css">
    <link rel="stylesheet" href="/css/map.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=3ee55d752effcbc08eda7914b122df74&libraries=services"></script>
</head>


<body>
<nav class="navbar navbar-expand-md bg-primary navbar-light border-bottom border-dark" style="	height: 80px;">
    <div class="container"><a class="navbar-brand" href="#"><img src="/images/bungae.png" width="100" height="30"
                                                                 class="d-inline-block align-top" alt=""></a>
        <button class="navbar-toggler navbar-toggler-right border-0" type="button" data-toggle="collapse"
                data-target="#navbar16">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbar16">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item"><a class="nav-link" href="main">홈</a></li>
                <li class="nav-item"><a class="nav-link" href="map">지도</a></li>
                <li class="nav-item"><a class="nav-link" href="bungae_create">번개생성</a></li>
                <li class="nav-item"><a class="nav-link" href="bungae_list">번개목록</a></li>
                <li class="nav-item"><a class="nav-link" href="bungae_ing">참여목록</a></li>
                <li class="nav-item"><a class="nav-link" href="profile" th:href="@{profile}">프로필</a></li>
            </ul>
            <a class="btn navbar-btn ml-md-2 btn-light text-dark" href="login">로그인<br></a>
        </div>
    </div>
</nav>
<div class="" style="">
    <div class="container">
        <div class="row">
            <div class="col-md-4" style="">
                <form class="form-inline mx-auto my-2">
                    <div class="input-group mx-auto">
                        <input type="text" class="form-control" id="inlineFormInputGroup" placeholder="Search"
                               style="width: 300px;">
                        <div class="input-group-append">
                            <button class="btn btn-primary" type="button"><i class="fa fa-search"></i></button>
                        </div>
                    </div>
                </form>
                <div class="list-group">
                    <a href="#" class="list-group-item list-group-item-action flex-column align-items-start">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">번개명</h5> <small class="text-muted">일시</small>
                        </div>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action flex-column align-items-start">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">번개명</h5> <small class="text-muted">일시</small>
                        </div>
                    </a><a href="#" class="list-group-item list-group-item-action flex-column align-items-start">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">번개명</h5> <small class="text-muted">일시</small>
                    </div>
                </a><a href="#" class="list-group-item list-group-item-action flex-column align-items-start">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">번개명</h5> <small class="text-muted">일시</small>
                    </div>
                </a><a href="#" class="list-group-item list-group-item-action flex-column align-items-start">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">번개명</h5> <small class="text-muted">일시</small>
                    </div>
                </a><a href="#" class="list-group-item list-group-item-action flex-column align-items-start">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">번개명</h5> <small class="text-muted">일시</small>
                    </div>
                </a><a href="#" class="list-group-item list-group-item-action flex-column align-items-start">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">번개명</h5> <small class="text-muted">일시</small>
                    </div>
                </a><a href="#" class="list-group-item list-group-item-action flex-column align-items-start">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">번개명</h5> <small class="text-muted">일시</small>
                    </div>
                </a><a href="#" class="list-group-item list-group-item-action flex-column align-items-start">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">번개명</h5> <small class="text-muted">일시</small>
                    </div>
                </a>
                </div>
            </div>
            <div class="col-md-8 d-flex flex-row justify-content-end align-items-center" id="map"
                 style="height: 600px;">
                <div class="row">
                    <div class="col-md-12 mr-3" style=""><span
                            class="btn btn-primary d-flex justify-content-center align-items-center" href="#"
                            style="	width: 30px;" id="myloc"><i class="fa fa-compass"></i></span></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="py-3 border-top border-dark">
    <div class="container">
        <div class="row">
            <div class="col-md-6" style=""><img src="/images/bungae.png" width="100" height="30"
                                                class="d-inline-block align-top" alt=""></div>
            <div class="col-md-6 text-center d-md-flex align-items-center">
                <ul class="nav mx-md-auto d-flex justify-content-center">
                    <li class="nav-item"><a class="nav-link active" href="#">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">Features</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">Pricing</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">About</a></li>
                </ul>

            </div>
        </div>
        <div class="row">
            <div class="col-md-12 text-center">
                <p class="mt-2 mb-0" contenteditable="true">© 2024 CodeNinja. All rights reserved</p>
            </div>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
        integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
<script>
    var map;
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            var lat = position.coords.latitude, // 위도
                lon = position.coords.longitude; // 경도

            var mapContainer = document.getElementById('map'), // 지도를 표시할 div
                mapOption = {
                    center: new kakao.maps.LatLng(lat, lon), // 지도의 중심좌표
                    level: 3 // 지도의 확대 레벨
                };

            // 지도를 생성합니다
            map = new kakao.maps.Map(mapContainer, mapOption);

            // 지도에 확대 축소 컨트롤을 생성한다
            var zoomControl = new kakao.maps.ZoomControl();

            // 지도의 우측에 확대 축소 컨트롤을 추가한다
            map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

            var locPosition = new kakao.maps.LatLng(lat, lon)
            var marker = new kakao.maps.Marker({
                        position: locPosition
            });
            marker.setMap(map);


        loadData();
});
} else {
    // Geolocation 사용 불가능할 때 처리
    alert("현 위치를 찾을 수 없습니다.");
}


// 생성된 번개모임 데이터를 불러오는 함수
function loadData() {
    $.ajax({
        url: 'bungae/getList', // 데이터를 가져올 URL
        type: 'GET', // 데이터 전송 방식
        dataType: 'json', // 받을 데이터 형식
        success: function(response) {
            var geocoder = new kakao.maps.services.Geocoder();
            // response는 모임 목록 데이터입니다.
            response.forEach(function(bungae, index) {
                // 주소로 좌표를 검색합니다
                geocoder.addressSearch(bungae.bungaeLocation.address, function(result, status) {
                    // 정상적으로 검색이 완료됐으면
                    if (status === kakao.maps.services.Status.OK) {
                        var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                        // 결과값으로 받은 위치를 마커로 표시합니다
                        var marker = new kakao.maps.Marker({
                            map: map,
                            position: coords
                        });

                        // 오버레이 컨텐츠에 고유한 ID를 부여합니다
                        var overlayId = 'overlay_' + index;

                        var content = '<div class="wrap">' +
                        '    <div class="info">' +
                        '        <div class="title">' + bungae.bungaeName +
                        '            <div class="close" onclick="closeOverlay(\'' + overlayId + '\')" title="닫기"></div>' +
                        '        </div>' +
                        '        <div class="body">' +
                        '            <div class="img">' +
                        '                <img src="" width="73" height="70">' +
                        '            </div>' +
                        '            <div class="desc">' +
                        '                <div class="ellipsis">' + bungae.bungaeLocation.keyword + '</div>' +
                        '                <div class="jibun ellipsis">' + bungae.bungaeLocation.address + '</div>' +
                        '                <div><a href="bungae/bungae_detail/' + bungae.bungaeId + '" class="link">상세보기</a></div>' +
                        '            </div>' +
                        '        </div>' +
                        '    </div>' +
                        '</div>';

                        var overlay = new kakao.maps.CustomOverlay({
                            content: content,
                            map: map,
                            position: marker.getPosition(),
                            zIndex: 1
                        });

                        // 오버레이를 숨김 상태로 시작합니다
                        overlay.setMap(null);

                        // 마커를 클릭했을 때 커스텀 오버레이를 표시합니다
                        kakao.maps.event.addListener(marker, 'click', function() {
                            overlay.setMap(map);
                        });

                        // 각 오버레이를 전역 객체로 저장합니다
                        window[overlayId] = overlay;
                    }
                });
            });
        },
        error: function(error) {
            console.log('Error:', error);
        }
    });
}

// 커스텀 오버레이를 닫기 위해 호출되는 함수입니다
function closeOverlay(overlayId) {
    var overlay = window[overlayId];
    if (overlay) {
        overlay.setMap(null);
    }
}


    // 버튼을 클릭하면 내 위치를 중심으로 지도화면 초기화
    document.getElementById('myloc').addEventListener('click', function(e) {
    e.preventDefault();

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            var lat = position.coords.latitude,
                lon = position.coords.longitude;
            var locPosition = new kakao.maps.LatLng(lat, lon);

            map.setCenter(locPosition);
            });
        } else {
            alert('Unable to use geolocation.');
        }
    });
</script>
</body>
</html>